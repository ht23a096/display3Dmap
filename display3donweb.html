<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Mapbox 3D Buildings</title>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #recenter-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1;
      padding: 10px;
      background: white;
      border-radius: 5px;
      border: 1px solid #ccc;
      cursor: pointer;
    }
    /* 避難所マーカー用スタイル */
    .shelter-marker {
      background-color: #007cbf;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid white;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="recenter-btn">現在地に戻る</button>
  <input type="file" id="imageInput" accept="image/*" style="display: none;" />

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoibmFrYWhhcmFsYWJvIiwiYSI6ImNtNzE4MmRpMTA0cWcybnIxY3Mwb2U2amgifQ.kvWh0YUk1c9nTHyAr1ooew';

    let map;
    let shouldFollowUser = false;

    // 避難所スポットデータ
    const shelterSpots = [
      {
        name: '大阪電気通信大学寝屋川キャンパス',
        description: 'J号館',
        coordinates: [135.6259, 34.7607],
        image: null
      },
      {
        name: '大阪電気通信大学寝屋川キャンパス',
        description: 'A号館',
        coordinates: [135.6260, 34.7604],
        image: null
      },
      {
        name: '大阪電気通信大学寝屋川キャンパス',
        description: 'クラブハウス',
        coordinates: [135.6254, 34.7601],
        image: null
      },
      {
        name: '大阪電気通信大学四条畷キャンパス',
        description: '2号館',
        coordinates: [135.6587, 34.7424],
        image: null
      },
      {
        name: '大阪電気通信大学四条畷キャンパス',
        description: '11号館',
        coordinates: [135.6594, 34.7420],
        image: null
      },
      {
        name: '大阪電気通信大学四条畷キャンパス',
        description: '5号館',
        coordinates: [135.6595, 34.7427],
        image: null
      },
      {
        name: '大阪電気通信大学四条畷キャンパス',
        description: '10号館',
        coordinates: [135.6602, 34.7431],
        image: null
      },
      {
        name: '大阪電気通信大学四条畷キャンパス',
        description: '体育館',
        coordinates: [135.6595, 34.7434],
        image: null
      },
      {
        name: '大阪電気通信大学四条畷キャンパス',
        description: 'コナミホール',
        coordinates: [135.6601, 34.7434],
        image: null
      },
      {
        name: '大阪電気通信大学四条畷キャンパス',
        description: '8号館',
        coordinates: [135.6612, 34.7435],
        image: null
      },
      {
        name: '大阪電気通信大学四条畷キャンパス',
        description: 'KOZUKIホール',
        coordinates: [135.6593, 34.7430],
        image: null
      },
      {
        name: '大阪電気通信大学四条畷キャンパス',
        description: '1号館',
        coordinates: [135.6588, 34.7419],
        image: null
      },
      {
        name: '大阪電気通信大学四条畷キャンパス',
        description: '6号館',
        coordinates: [135.6602, 34.7436],
        image: null
      }
    ];

    document.getElementById('recenter-btn').addEventListener('click', () => {
      if (window.currentPosition) {
        shouldFollowUser = true;
        map.flyTo({
          center: [window.currentPosition.coords.longitude, window.currentPosition.coords.latitude]
        });
      }
    });

    const geoOptions = {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    };

    if ('geolocation' in navigator) {
      // 初回現在地取得 → 地図初期化
      navigator.geolocation.getCurrentPosition(initMap, geoError, geoOptions);

      // 位置の追跡開始
      navigator.geolocation.watchPosition(updatePosition, geoError, geoOptions);
    } else {
      alert('お使いのブラウザでは、位置情報の取得がサポートされていません。');
    }

    function initMap(position) {
      const { latitude, longitude } = position.coords;
      window.currentPosition = position;

      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [longitude, latitude], // 現在地で開始
        zoom: 15,
        pitch: 60,
        bearing: 20,
        antialias: true
      });

      map.on('load', () => {
        map.addSource('mapbox-dem', {
          type: 'raster-dem',
          url: 'mapbox://mapbox.mapbox-terrain-dem-v1',
          tileSize: 512,
          maxzoom: 14
        });

        map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.5 });

        map.addLayer({
          id: 'sky',
          type: 'sky',
          paint: {
            'sky-type': 'atmosphere',
            'sky-atmosphere-sun': [0.0, 0.0],
            'sky-atmosphere-sun-intensity': 15
          }
        });

        map.addLayer({
          id: '3d-buildings',
          source: 'composite',
          'source-layer': 'building',
          type: 'fill-extrusion',
          minzoom: 14,
          paint: {
            'fill-extrusion-color': '#aaa',
            'fill-extrusion-height': [
              'interpolate', ['linear'], ['zoom'],
              14, 0,
              16, ['get', 'height']
            ],
            'fill-extrusion-base': ['get', 'min_height'],
            'fill-extrusion-opacity': 0.8
          }
        });

        // 避難所スポットをマップに追加
        addShelterSpots();
      });
    }

    function updatePosition(position) {
      const { latitude, longitude, accuracy } = position.coords;
      window.currentPosition = position;

      if (accuracy > 30) {
        console.warn(`位置情報の誤差が大きいため更新をスキップ（誤差: ${accuracy}m）`);
        return;
      }

      // 既存マーカー削除
      if (window.currentMarker) {
        window.currentMarker.remove();
      }

      // 新しいマーカー追加
      window.currentMarker = new mapboxgl.Marker({ color: 'pink' })
        .setLngLat([longitude, latitude])
        .addTo(map);

      // 「現在地に戻る」操作時だけ flyTo
      if (shouldFollowUser && map) {
        map.flyTo({ center: [longitude, latitude] });
        shouldFollowUser = false;
      }
    }

    function geoError(err) {
      console.warn(`位置情報の取得に失敗しました（エラーコード: ${err.code}）`);

      function addShelterSpots() {
  shelterSpots.forEach((spot, index) => {
    const el = document.createElement('div');
    el.className = 'shelter-marker';

    const popupContent = createPopupContent(spot, index);
    const popup = new mapboxgl.Popup({ offset: 25 }).setDOMContent(popupContent);
  }

    new mapboxgl.Marker(el)
      .setLngLat(spot.coordinates)
      .setPopup(popup)
      .addTo(map);

    // 円を追加する
    addShelterRangeCircle(spot, index);
      });
    }

    // 避難所スポットを追加する関数
    function addShelterSpots() {
  shelterSpots.forEach((spot, index) => {
    const el = document.createElement('div');
    el.className = 'shelter-marker';

    const popupContent = createPopupContent(spot, index);

    const popup = new mapboxgl.Popup({ offset: 25 });
    popup.setDOMContent(popupContent);  // DOMを直接設定

    new mapboxgl.Marker(el)
      .setLngLat(spot.coordinates)
      .setPopup(popup)
      .addTo(map);
      });
    }
    function createPopupContent(spot, index) {
      const container = document.createElement('div');
      
      const title = document.createElement('h3');
      title.textContent = spot.name;
      
      const desc = document.createElement('p');
      desc.textContent = spot.description;
      const img = document.createElement('img');
      img.style.width = '100%';
      img.style.marginTop = '5px';
      if (spot.image) {
        img.src = spot.image;
  }
      
      const btn = document.createElement('button');
      btn.textContent = '画像を選択';
      btn.style.marginTop = '5px';
      btn.addEventListener('click', () => {
        const input = document.getElementById('imageInput');
        if (!input){
          alert('画像入力フォームが見つかりません。 ');
          return;
        }
        input.click();
        
        input.onchange = () => {
          const file = input.files[0];
          if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = () => {
              spot.image = reader.result;
              img.src = spot.image;
            };
            reader.readAsDataURL(file);
          }
        };
      });
      
      container.appendChild(title);
      container.appendChild(desc);
      container.appendChild(btn);
      container.appendChild(img);

  return container;
}

// Turf.js を使って円を描画
    function addShelterRangeCircle(spot, index) {
      const radiusInMeters = 5;
      const point = turf.point(spot.coordinates);
      const circle = turf.circle(point, radiusInMeters, {
        steps: 64,
        units: 'meters'
      });

      map.addSource(`shelter-circle-${index}`, {
        type: 'geojson',
        data: circle
      });

      map.addLayer({
        id: `shelter-circle-layer-${index}`,
        type: 'fill',
        source: `shelter-circle-${index}`,
        layout: {},
        paint: {
          'fill-color': '#007cbf',
          'fill-opacity': 0.2
        }
      });
    }
  </script>
</body>
</html>
